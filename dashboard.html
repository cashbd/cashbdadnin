<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - CASHBD Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>CASHBD Admin</h2>
        <a href="dashboard.html" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="deposits.html" class="nav-link"><i class="fas fa-wallet"></i> Deposits</a>
        <a href="withdrawals.html" class="nav-link"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a>
        <a href="users.html" class="nav-link"><i class="fas fa-users"></i> Users</a>
        <a href="settings.html" class="nav-link"><i class="fas fa-cogs"></i> Settings</a>
        <a href="plans.html" class="nav-link"><i class="fas fa-rocket"></i> Plans</a>
        <button onclick="adminLogout()" class="btn btn-red" style="margin-top:auto;">Logout</button>
    </div>

    <div class="main">
        <div class="header">
            <h1>Dashboard Overview</h1>
        </div>

        <!-- Action Required -->
        <h3 style="color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">Action Required</h3>
        <div class="stats-grid">
            <div class="stat-card" style="border-color: var(--accent);">
                <i class="fas fa-clock stat-icon text-orange"></i>
                <div class="stat-val text-orange" id="pendDep">0</div>
                <div class="stat-label">Pending Deposits</div>
            </div>
            <div class="stat-card" style="border-color: var(--accent);">
                <i class="fas fa-exclamation-circle stat-icon text-orange"></i>
                <div class="stat-val text-orange" id="pendWith">0</div>
                <div class="stat-label">Pending Withdrawals</div>
            </div>
        </div>

        <!-- Financial Overview -->
        <h3 style="color: #888; margin-bottom: 15px; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px;">Financial Overview</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-arrow-down stat-icon text-green"></i>
                <div class="stat-val text-green">৳ <span id="totalDep">0</span></div>
                <div class="stat-label">Total Approved Deposit</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-arrow-up stat-icon text-red"></i>
                <div class="stat-val text-red">৳ <span id="totalWith">0</span></div>
                <div class="stat-label">Total Approved Withdraw</div>
            </div>
        </div>

        <!-- User Base -->
        <h3 style="color: #888; margin-bottom: 15px; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px;">User Base</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-users stat-icon"></i>
                <div class="stat-val" id="totalUsers">0</div>
                <div class="stat-label">Total Registered Users</div>
            </div>
        </div>
    </div>

    <script src="firebase.js"></script>
    <script src="admin.js"></script>
    <script>
        // Helper to safely clean amount string to number
        function cleanAmount(val) {
            if (!val) return 0;
            // Remove "৳", commas, spaces, etc., keep only numbers and dot
            let cleaned = String(val).replace(/[^0-9.]/g, '');
            return parseFloat(cleaned) || 0;
        }

        // 1. COUNT TOTAL USERS
        db.ref('users').on('value', snap => {
            const count = snap.exists() ? snap.numChildren() : 0;
            document.getElementById('totalUsers').innerText = count;
        });

        // 2. CALCULATE DEPOSITS
        db.ref('deposits').on('value', snap => {
            let pendingCount = 0;
            let approvedAmount = 0;

            snap.forEach(c => {
                const d = c.val();
                const status = (d.status || "").toLowerCase();
                const amt = cleanAmount(d.amount); // Clean parsing

                if (status === 'pending') {
                    pendingCount++;
                } else if (status === 'approved') {
                    approvedAmount += amt;
                }
            });

            document.getElementById('pendDep').innerText = pendingCount;
            document.getElementById('totalDep').innerText = approvedAmount.toLocaleString();
        });

        // 3. CALCULATE WITHDRAWALS
        db.ref('withdrawals').on('value', snap => {
            let pendingCount = 0;
            let approvedAmount = 0;

            snap.forEach(c => {
                const w = c.val();
                const status = (w.status || "").toLowerCase();
                const amt = cleanAmount(w.amount); // Clean parsing

                if (status === 'pending') {
                    pendingCount++;
                } else if (status === 'approved') {
                    approvedAmount += amt;
                }
            });

            document.getElementById('pendWith').innerText = pendingCount;
            document.getElementById('totalWith').innerText = approvedAmount.toLocaleString();
        });
    </script>
</body>
</html>